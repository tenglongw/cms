<?php
namespace app\admin\controller;class Upgrade extends\app\admin\controller\Common{public function index(){if(request()->isGet()){$this->success('','',$this->fetch());}elseif(request()->isPost()){$b=include CONF_PATH.'version.php';$c=['version'=>$b['version'],'page'=>input('page'),'rows'=>input('rows'),];$d=\ebcms\Server::api('version_all',$c);if($d['code']){$this->success($d['msg'],'',$d['data']);}else{$this->error($d['msg'],'',$d['data']);}}}public function upgrade(){$b=include CONF_PATH.'version.php';$c=['version'=>$b['version'],];$d=\ebcms\Server::api('version_next',$c);if(!$d['code']){$this->error($d['msg'],'',$d['data']);}$d=$d['data'];$e=\ebcms\Config::get('system.backup_path').DS.'patch'.DS;$f=\ebcms\Config::get('system.backup_path').DS.'file'.DS;if(request()->isGet()){if(!is_dir($e)){if(is_writable(dirname($e))){mkdir($e,0755,true);}else{$this->error('无法创建文件夹，请检查'.dirname($e).'的权限！');}}elseif(!is_writable($e)){$this->error($e.'文件夹不存在或权限不足！请修改！');}if(!is_dir($f)){if(is_writable(dirname($f))){mkdir($f,0755,true);}else{$this->error('无法创建文件夹，请检查'.dirname($f).'的权限！');}}elseif(!is_writable($f)){$this->error($f.'文件夹不存在或权限不足！请修改！');}if($d['file']){$g=$e.'ebcms_patch_v'.$d['version'].'.zip';if(!is_file($g)||$d['file_md5']!=md5(file_get_contents($g))){$h=file_get_contents($d['file']);if($d['file_md5']!=md5($h)){$this->error('文件校验失败！请重新下载！');}if(is_file($g)&&!is_writable($g)){$this->error($g.'文件已经存在！请修改该文件权限！');}file_put_contents($g,$h);}$i=[];$j=[];$this->checkzip($g,$i,$j);$this->assign('files',$i);$this->assign('error',$j?1:0);$this->assign('errors',array_unique($j));}if($d['exec']){$k=$e.'ebcms_patch_v'.$d['version'].'.php';if(!is_file($k)||$d['file_md5']!=md5(file_get_contents($k))){$h=file_get_contents($d['exec']);if($d['exec_md5']!=md5($h)){$this->error('文件校验失败！请重新下载！');}if(is_file($k)&&!is_writable($k)){$this->error($k.'文件已经存在但无法修改！请修改该文件权限！');}file_put_contents($k,$h);}$this->assign('exec',1);}$this->assign('res',$d);$this->success('','',$this->fetch());}elseif(request()->isPost()){if($d['file']){$g=$e.'ebcms_patch_v'.$d['version'].'.zip';$i=[];$j=[];$this->checkzip($g,$i,$j);if($j){$this->error('文件权限校验失败！');}$l=$f.$b['version'].DS;$this->backup_files($i,$l);$this->update_files($g);}if($d['exec']){$m=$e.'ebcms_patch_v'.$d['version'].'.php';include $m;if(function_exists('ebcms_upgrade')){if(true!==$n=ebcms_upgrade()){$this->error($n);}}}$this->success('更新成功！');}}private function checkzip($g,&$i,&$j){$o=zip_open($g);while($p=zip_read($o)){if(zip_entry_open($o,$p)){$q=zip_entry_name($p);$r=ROOT_PATH.$q;if(pathinfo($r,PATHINFO_EXTENSION)){if(is_file($r)){if(is_writable($r)){$i[$q]=true;}else{$j[]=$r;$i[$q]=false;}}else{$i[$q]=$this->checkpath(dirname($r),$j);}}zip_entry_close($p);}}zip_close($o);}private function checkpath($s,&$j){if(is_dir($s)){if(is_writable($s)){return true;}else{$j[]=$s;return false;}}else{return $this->checkpath(dirname($s),$j);}}private function update_files($g){$o=zip_open($g);while($p=zip_read($o)){if(zip_entry_open($o,$p)){$q=zip_entry_name($p);$t=zip_entry_filesize($p);if(0===strpos($q,'public')){$g='.'.substr($q,6);}else{$g=ROOT_PATH.$q;}if(pathinfo($g,PATHINFO_EXTENSION)){$t=zip_entry_filesize($p);$u=zip_entry_read($p,$t);file_put_contents($g,$u);}else{if(!is_dir($g)){mkdir($g,0755,true);}}zip_entry_close($p);}}zip_close($o);return true;}private function backup_files($i,$s){if(!is_dir($s)){mkdir($s,0755,true);}foreach($i as $q=>$w){if(0===strpos($q,'public')){$g='.'.substr($q,6);}else{$g=ROOT_PATH.$q;}if(is_file($g)){$x=str_ireplace(['/','\\'],'____',$q);file_put_contents($s.$x.'.php',file_get_contents($g));}}}}